#!/usr/bin/env bash

set -o errexit -o nounset

GIT_ROOT=${GIT_ROOT:-$(git rev-parse --show-toplevel)}
cd "${GIT_ROOT}"
source .envrc

ENV_FILES="$(echo bin/settings/*.env bin/settings/kube/*.env)"

CREATE_HELM_CHART=false
BUILD_TARGET=kube

if [ "${1:-}" = "helm" ]; then
    CREATE_HELM_CHART=true
    BUILD_TARGET=helm
    ENV_FILES="$(echo bin/settings/certs.env bin/settings/kube/ca.env)"
fi

rm -rf "${BUILD_TARGET}"

# TODO: We currently skip memory limits for development purposes
fissile build "${BUILD_TARGET}" \
    --output-dir="${BUILD_TARGET}" \
    --defaults-file="$(echo "${ENV_FILES}" | tr ' ' ,)"

# This is a small hack to make the output of make kube be compatible with K8s 1.6
perl -p -i -e 's@extensions/v1beta1@batch/v1@' $(grep -rl "kind: Job" "${BUILD_TARGET}")
