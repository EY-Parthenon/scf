#!/bin/bash

set -e

export PATH=/var/vcap/packages/cli/bin:${PATH} # put the cli on the path

cf plugins | grep -q cf-plugin-usb || {
  cf install-plugin /var/vcap/packages/cf-plugin-usb/bin/cf-plugin-usb
}

# helper function to retry a command several times, with a delay between trials
# usage: retry <max-tries> <delay> <command>...
function retry () {
    max=${1}
    delay=${2}
    i=0
    shift 2

    while test ${i} -lt ${max} ; do
        if "$@" ; then
            break
        fi
        sleep "${delay}"
        i="$(expr ${i} + 1)"
    done
}


<% skip_ssl_validation = properties.ssl.skip_cert_verify ? '--skip-ssl-validation' : '' %>
retry 240 30s    cf api <%= skip_ssl_validation %> api.<%= properties.system_domain %>
<% 
username, password = properties.uaa.scim.users.detect{|u|u.include? 'cloud_controller.admin'}.split('|')[0..1]
%>
cf auth <%= username.shellescape %> <%= password.shellescape %>

for i in {1..10}; do cf usb target http://usb.<%= properties.system_domain %> && break || sleep 20; done
for i in {1..10}; do cf usb create-instance mongo mongodb -c "{\"server\":\"dev-service-mongodb.hcf\",\"port\":\"27017\",\"userid\":\"admin\",\"password\":\"<%= properties.dev_services.mongodb.admin_password %>\"}" && break || sleep 20; done
for i in {1..10}; do cf usb create-instance mysql mysql -c "{\"server\":\"dev-service-mysql.hcf\",\"port\":\"3306\",\"userid\":\"root\",\"password\":\"<%= properties.dev_services.mysql.admin_password %>\"}" && break || sleep 20; done
for i in {1..10}; do cf usb create-instance postgres postgres -c "{\"host\":\"dev-service-postgres.hcf\",\"port\":\"5432\",\"user\":\"postgres\",\"password\":\"<%= properties.dev_services.postgres.admin_password %>\",\"dbname\":\"postgres\",\"sslmode\":\"disable\"}" && break || sleep 20; done
for i in {1..10}; do cf usb create-instance rabbitmq rabbitmq -c "{\"docker_endpoint\":\"http://dev-service-rabbitmq.hcf:4444\",\"docker_image\":\"rabbitmq\",\"docker_image_version\":\"3.6.0-management\"}" && break || sleep 20; done
for i in {1..10}; do cf usb create-instance redis redis -c "{\"docker_endpoint\":\"http://dev-service-redis.hcf:4444\",\"docker_image\":\"redis\",\"docker_image_version\":\"3.0.7\"}" && break || sleep 20; done
