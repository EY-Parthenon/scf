#!/bin/bash

<% username, password = properties.uaa.scim.users.detect{|u|u.include? 'cloud_controller.admin'}.split('|')[0..1] %>

set -e

# put the cli on the path
export PATH=/var/vcap/packages/cli/bin:${PATH}

# helper function to retry a command several times, with a delay between trials
# usage: retry <max-tries> <delay> <command>...
function retry () {
    max=${1}
    delay=${2}
    i=0
    shift 2

    while test ${i} -lt ${max} ; do
        if "$@" ; then
            break
        fi
        sleep "${delay}"
        i="$(expr ${i} + 1)"
    done
}

function edit_config () {
    key="$1"
    value="$2"
    pattern="s|\"$key\":[ 	]*\".*\",$|\"$key\": \"$value\",|"
    sed < $HOME/.cf/config.json > $$ -e "$pattern"
    mv $$ $HOME/.cf/config.json
}

function retarget_auth () {
    # Manipulate the authentication endpoints saved by the `cf api`
    # command.  This fakes `cf auth` out, forcing it to use the
    # internal auth host. Note the special port for https.

    edit_config AuthorizationEndpoint "$UAA_ENDPOINT"
    edit_config UaaEndpoint           "$UAA_ENDPOINT"
}

function select_action () {
    SERVICE="$1"

    # Check if the broker is known already or not. Depending on the
    # result we simply update the existing broker, or create a new one.

    action=create
    if cf service-brokers 2>/dev/null | grep --quiet "$SERVICE" ; then
	action=update
    fi
    echo $action
}

function register_service () {
    SERVICE="$1"
    USER="$2"
    PASS="$3"
    ENDPOINT="$4"

    cf $(select_action "$SERVICE")-service-broker "$SERVICE" "$USER" "$PASS" "$ENDPOINT"

    # Make the broker available to all orgs and their spaces
    cf enable-service-access "$SERVICE"
}

SKIP="<%= properties.ssl.skip_cert_verify ? '--skip-ssl-validation' : '' %>"
USER="<%= username.shellescape %>"
PASSWORD="<%= password.shellescape %>"

AS_PORT="<%= p("tomcat.http.autoscaler_servicebroker.port") %>"
AS_USER="<%= p("autoscaler_servicebroker.auth.username") %>"
AS_PASS="<%= p("autoscaler_servicebroker.auth.password") %>"
AS_SERVICE="<%= p("autoscaler_api.scaling_service.name") %>"

UAA_ENDPOINT="<%= p('hcf.uaa.internal-url') %>"
AS_ENDPOINT="http://${AUTOSCALER_SERVICE_BROKER_HOST}.${HCP_SERVICE_DOMAIN_SUFFIX}:$AS_PORT"
API_ENDPOINT="${API_HOST}.${HCP_SERVICE_DOMAIN_SUFFIX}:9022"

echo "Waiting for CC... $SKIP $API_ENDPOINT"
retry 240 30s cf api $SKIP "$API_ENDPOINT"

retarget_auth

echo "Waiting for UAA..."
retry 240 30s cf auth "$USER" "$PASSWORD"

echo "Waiting for Autoscaler service broker..."
retry 240 30s curl --fail --silent --insecure $AS_ENDPOINT >/dev/null 2>&1

echo "Registering Autoscaler service broker..."
register_service "$AS_SERVICE" "$AS_USER" "$AS_PASS" "$AS_ENDPOINT/servicebroker"

echo "Registration of Autoscaler complete."
