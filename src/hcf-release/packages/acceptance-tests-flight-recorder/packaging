set -e -x

#build flight recorder
REPO_NAME=github.com/hpcloud/hdp-resource-manager

REPO_DIR=${BOSH_INSTALL_TARGET}/src/${REPO_NAME}

mkdir -p $(dirname $REPO_DIR)

cp -a $REPO_NAME/ $REPO_DIR

export GOROOT=$(readlink -nf /var/vcap/packages/golang1.6)
export PATH=$GOROOT/bin:$PATH
export GOPATH=${BOSH_INSTALL_TARGET}

go build -o ${BOSH_INSTALL_TARGET}/bin/flight-recorder ${REPO_DIR}/cmd/flightrecorder/main.go

#copy necessary files
mkdir -p ${BOSH_INSTALL_TARGET}/config/
cp acceptance-tests-flight-recorder/check.sh ${BOSH_INSTALL_TARGET}/bin/
cp hcf-config/role-manifest.yml ${BOSH_INSTALL_TARGET}/config/

export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

#compute source_to_check.txt
/var/vcap/packages/ruby-2.3/bin/ruby acceptance-tests-flight-recorder/generate_check_roles.rb

